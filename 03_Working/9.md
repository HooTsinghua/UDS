# 9 诊断和通信管理的功能单元

## 9.1 概览

表格22定义了诊断和通信管理的功能单元。

表格22

|服务|描述|
|:--|:--|
|诊断会话控制 |客户端向服务端请求控制诊断会话 |
|ECU复位     |客户端强制服务端执行复位      |
|安全访问     |客户端请求解锁安全服务      |
|通讯控制|客户端使用这个服务控制通信参数配置(如：通信波特率)|
|测试信号保持|客户端向服务端表明它仍然存在|
|时间相关参数入口| 客户端使用该服务读取/修改一个活跃通信的时间相关参数|
|安全数据传输| 客户端使用此服务以扩展数据链接安全性进行数据传输|
|控制DTC设置| 客户端控制DTC的设置|
|时间响应|客户端请求建立和/或控制事件机制|
|链接控制|客户端请求控制通信波特率 |

注:
    客户端 - 诊断设备
    服务端 - ECU

## 9.2 诊断会话控制(0x10)服务

### 9.2.1服务说明

诊断会话控制服务用于启用不同的诊断会话。

一个诊断会话支持一个特定的诊断服务或者会话中的功能。该服务提供了子服务可以报告数据链路层特定参数值的能力，这些参数值对于启用的诊断会话(例如时间参数值)是有效的。该国际标准的用户应定义在每个诊断会话中启用的服务和(或)功能的确切集合。

在服务端中总是有一个诊断会话是活跃的。服务端在启动时应始终启动默认诊断会话。如果没有启动其他诊断会话，则默认诊断会话应在服务端供电时运行。

在正常的操作条件下，以及在汽车制造商定义的其他操作条件下(如：跛行回家操作情景)，服务端应该能够提供诊断功能。

如果客户端请求一个已运行的诊断会话，则服务端应发送一个正响应消息，并按照图7所示的方式运行，它描述了在会话之间转换时服务端的内部行为。

每当客户端请求新的诊断会话时，服务端将在对这个新的会话激活计时之前，发送诊断会话控制的正响应回复。有些情况可能要求在发送响应之前必须输入新会话，而保持旧的协议计时以发送响应。如果服务端无法启动所请求的新诊断会话，则它将以诊断会话控制的负面响应消息进行响应，并且当前会话将继续(参见诊断会话参数定义，以了解关于服务端和客户端应如何行为的进一步信息)。非默认的诊断服务(不包括可编程会话)的诊断功能集和诊断会话是默认会话中提供的功能的超集，这意味着在切换到任何非缺省诊断会话时，也可以使用默认的诊断功能。一个会话可以使汽车制造商制定特定的服务和功能，这就不属于本文档的定义范畴了。

为了启动新的诊断会话，服务端可以要求满足某些条件。所有这些条件都是用户定义的。比如下面的例子：

——  该服务端可以只允许具有特定客户端标识符（客户端诊断地址）的客户端启动特定的新诊断会话（例如，服务端可能要求只有具有客户端标识符0xF4的客户端才可以启动扩展诊断会话）。

——  某些安全条件可能需要满足（例如，车辆不能移动或发动机不能运行）。


图7表示诊断会话转换的图示，以及服务端在会话切换时需要执行的操作：

![Alt 图7](Figure7.PNG "图7")

###图解
1   默认会话：当服务端正处于默认会话，同时客户端请求开始默认会话，此时服务端应该完全的重新初始化默认会话。客户端应该重启（reset）所有已激活的会话中的激活/初始化/更改的设置/控件。这并不包括编写到非易失性内存中的长期更改。

2   其它会话：当服务端从默认会话转换到任何其它会话时，服务端只应停止已在默认会话中的ResponseOnEvent(0x86响应事件）服务中配置的事件（类似于stopResonseOnEvent停止响应事件）。

3   相同或者其它的会话：当服务端从任何其它诊断会话转换到非默认会话时，服务端应该（重新）初始化诊断会话，这个包括了以下三种情况：
i)    服务端中通过ResponseOnEvent(0x86响应事件）配置的每一个事件都应当被停止。
ii)   安全性应被重新锁定。注意，安全访问的锁定将重置依赖于安全访问的任何主动诊断功能，以便被解锁（例如，已激活的DID输入输出控制）。
iii)  在新会话中被支持并且不依赖于安全访问的所有其它活动诊断功能将被保持。例如，在从一个非默认会话转换到另一个或相同的非默认会话时，任何配置的定期调度器都应该保持活动状态，通信控制和控制设置服务的状态不受影响。也就是说，当会话切换时，正常的通信被禁用时，它将继续被禁用。

4   默认会话，当服务端从任何其它诊断会话中切换到默认会话时，服务端将终止服务中的每一项活动事件，通过ResponseOnEvent(0x86响应事件）配置的每一个事件都应当被停止。在默认会话中不支持的任何其他活动诊断功能将被终止。例如，任何已配置的定期调度器或输出控制都应被禁用，通信控制和控制控制服务的状态将被重置。意味着正常通信在服务中被禁用，当服务会话转换为默认会话，这个正常通讯会重新被启用。服务器应在激活会话期间重置所有激活/初始化/更改的设置/控件。这并不包括编写到非易失性内存中的长期更改。

